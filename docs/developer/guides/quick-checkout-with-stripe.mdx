---
title: Completing the checkout via quick checkout with Stripe and Spree API
description: This guide will show you how to add quick checkout to your custom storefront using Stripe and Spree APIs.
---

<Warning>
  This guide is aimed at advanced users who have some experience with Spree API and Stripe.
  You also need [spree_stripe](https://github.com/spree/spree_stripe) gem in your Spree application
</Warning>

Spree Storefront with the `spree_stripe` gem already has quick checkout built in, but if you like to add quick checkout to your custom storefront, then this guide will help you with that.

Let's assume that you have a cart made with line items in it already.

Quick checkout works by handling 3 different events:
- Address change
- Shipping Method/Rate change
- Confirmation

How you should handle them depends on your platform/language:
- When using Web and JS, you should look at the Express Checkout Element:
  - https://docs.stripe.com/elements/express-checkout-element
  - https://docs.stripe.com/js/element/express_checkout_element
  - You can also check out the `spree_stripe` implementation here: https://github.com/spree/spree_stripe/blob/main/app/javascript/spree_stripe/controllers/stripe_button_controller.js.
- On iOS, you should probably check out:
  - `StripeApplePay` https://docs.stripe.com/apple-pay
  - `STPApplePayContext` https://stripe.dev/stripe-ios/stripeapplepay/documentation/stripeapplepay/stpapplepaycontext#instance-methods

After you have a code that will handle those events, here's what you should do in each event:

### Address change
Here we need to send some basic information about the customer's shipping address, and we should move the order to the delivery step (don't forget to replace the placeholders with the customer's data):

<AccordionGroup>
<Accordion title="Update the checkout">


[Endpoint documentation](https://spreecommerce.org/docs/api-reference/storefront/checkout/update-checkout)


```bash Update order [expandable]
curl -X PATCH <SHOP URL>/api/v2/storefront/checkout \
  -H 'Authorization: Bearer <Token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "order": {
      "ship_address_attributes": {
        "quick_checkout": true,
        "firstname": <First name>,
        "lastname": <Last name>,
        "city": <City>,
        "zipcode": <Zip>,
        "country_iso": <Country>,
        "state_name": <State>
      },
      "bill_address_id": "CLEAR"
    }
  }'
```

<ParamField body="quick_checkout" type="bool" required>
    `true` indicating that the order is from quick checkout
</ParamField>

<ParamField body="firstname" type="string" required>
  Customer's first name
</ParamField>

<ParamField body="lastname" type="string" required>
  Customer's last name
</ParamField>

<ParamField body="city" type="string" required>
  Customer's city
</ParamField>

<ParamField body="zipcode" type="string" required>
  Customer's zip code
</ParamField>

<ParamField body="country_iso" type="string" required>
  Customer's country ISO
</ParamField>

<ParamField body="state_name" type="string">
  Customer's address state
</ParamField>

<ParamField body="bill_address_id" type="string" required>
  Set it to `CLEAR` to clear existing billing address (this prevents order to accidentally advancing to the `payment` step)
</ParamField>
</Accordion>
<Accordion title="Move the order to the delivery step">
[Endpoint documentation](https://spreecommerce.org/docs/api-reference/storefront/checkout-state/advance-checkout)

```sh Advance order to the delivery step
curl -X PATCH '<SHOP URL>/api/v2/storefront/checkout/advance?state=delivery&include=shipments.shipping_rates' \
  -H 'Authorization: Bearer <Token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "quick_checkout": true,
    "shipping_method_id": <Shipping Method ID>
  }'
```

<ParamField body="quick_checkout" type="bool" required>
  `true` indicating that the order is from quick checkout
</ParamField>

<ParamField body="shipping_method_id" type="string">
  You don't have to send `shipping_method_id` if you don't have it yet, but if you received `Shipping Method/Rate changed` event, and you already have the selected shipping method, then you can send it.
</ParamField>

This will return you an order response, and you can update the payment element with a new total (you should use `total_minus_store_credits` for total) and shipping rates.
</Accordion>

</AccordionGroup>


### Shipping Method/Rate change

Here we need to send the selected shipping method to the backend and update the total in the payment element

[Endpoint documentation](https://spreecommerce.org/docs/api-reference/storefront/checkout-shipments/selects-shipping-method-for-shipments)

```sh Select shipping method
curl -X PATCH '<SHOP URL>/api/v2/storefront/checkout/select_shipping_method' \
  -H 'Authorization: Bearer <Token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "shipping_method_id": <Shipping Method ID>
  }'
```

<ParamField body="shipping_method_id" type="string" required>
  Shipping method ID of the selected shipping rate
</ParamField>

Subsequently, update the payment element with a new total taken from the response's `total_minus_store_credits`

### Confirming the payment

Now you should make several more calls to the backend

<AccordionGroup>
<Accordion title="Confirm that the order is ready for the payment">
[Endpoint documentation](https://spreecommerce.org/docs/api-reference/storefront/checkout/validate-order-payment)
```sh Validate order for payment
curl -X POST '<SHOP URL>/api/v2/storefront/checkout/validate_order_for_payment?skip_state=true' \
  -H 'Authorization: Bearer <Token>'
```

If you receive a response code other than `200` then something changed in the order, and it can't be moved to the payment state yet.
</Accordion>


<Accordion title="Update the address with more data">

You should have a lot more information about the customer (in previous events, Stripe probably will not provide you information such as customer address), so send them to the backend:

[Endpoint documentation](https://spreecommerce.org/docs/api-reference/storefront/checkout/update-checkout)

```sh Update the order [expandable]
curl -X PATCH <SHOP URL>/api/v2/storefront/checkout \
  -H 'Authorization: Bearer <Token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "order": {
      "email": <EMAIL>,
      "ship_address_attributes": {
        "quick_checkout": true,
        "firstname": <First name>,
        "lastname": <Last name>,
        "address1": <Address>,
        "address2": <Address 2>,
        "city": <City>,
        "zipcode": <Zip>,
        "country_iso": <Country>,
        "state_name": <State>,
        "phone": <Phone>
      }
    },
    "do_not_change_state": true
  }'
```
<ParamField body="email" type="string" required>
    Customer's email
</ParamField>

<ParamField body="quick_checkout" type="bool" required>
    `true` indicating that the order is from quick checkout
</ParamField>

<ParamField body="firstname" type="string" required>
  Customer's first name
</ParamField>

<ParamField body="lastname" type="string" required>
  Customer's last name
</ParamField>

<ParamField body="zipcode" type="string" required>
  Customer's zip code
</ParamField>

<ParamField body="country_iso" type="string" required>
  Customer's country ISO
</ParamField>

<ParamField body="state_name" type="string">
  Customer's address state
</ParamField>

<ParamField body="phone" type="string">
  Customer's phone number
</ParamField>

<ParamField body="do_not_change_state" type="bool" required>
  Set it to `true` so the order does not advance to the next state
</ParamField>
</Accordion>


<Accordion title="Move the order to the payment step">
[Endpoint documentation](https://spreecommerce.org/docs/api-reference/storefront/checkout-state/advance-checkout)
```sh Move the order to the payment step
curl -X PATCH '<SHOP URL>/api/v2/storefront/checkout/advance?state=payment' \
  -H 'Authorization: Bearer <Token>' \
  -d '{
    "shipping_method_id": <Shipping Method ID>
  }'
```
<ParamField body="shipping_method_id" type="string" required>
  Shipping method ID of the selected shipping rate
</ParamField>
</Accordion>
</AccordionGroup>


Thereafter, you should confirm the payment intent using the Stripe library; this depends on your platform/language.

If you like to redirect the user to Spree's order summary page, then set the `return_url` when confirming the payment intent to `<SHOP URL>/stripe/payment_intents/<PAYMENT INTENT ID>`. This will check if the payment intent is confirmed, move the order to the complete state, and redirect the user to the order summary.

If you like to make the order summary page by yourself, then after confirming the payment intent in Stripe, make this request:



```sh Confirm payment intent
curl -X POST <SHOP URL>/api/v2/storefront/stripe/payment_intents/<PAYMENT INTENT ID>/confirm \
  -H 'Authorization: Bearer <Token>'
```
[Endpoint documentation](https://spreecommerce.org/docs/api-reference/storefront/stripe/mark-the-payment-intent-as-confirmed-and-move-the-order-to-the-complete-state)

This will also check if the payment intent is confirmed, and it will move the order to the complete state

#### User cancels the payment

If at any point, the user cancels the payment (closes the quick checkout sheet/modal), then clear the shipping and billing address from the order.

```sh Reset order addresses
curl -X PATCH <SHOP URL>/api/v2/storefront/checkout \
  -H 'Authorization: Bearer <Token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "order": {
      "ship_address_id": "CLEAR",
      "bill_address_id": "CLEAR"
    }
  }'
```

[Endpoint documentation](https://spreecommerce.org/docs/api-reference/storefront/checkout/update-checkout)

### All Done!

Congrats! Now, your users should be able to pay for orders with quick checkout! Need support or want to give some feedback? You can join our [community](https://slack.spreecommerce.org/) or drop us an email at [hello@spreecommerce.org](mailto:hello@spreecommerce.org).